<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GemTask_v4.0</title>
	<link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="icon-512.png">
    <link rel="icon" type="image/png" href="icon-512.png">
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (å…±é€š) --- */
        :root {
            --bg-color: #FDFBF7;
            --text-color: #5D5550;
            --accent-color: #D4C4B5;
            --highlight: #A8D8B9;
            --pending-dot: #F4A261;
            --delete-btn: #E07A5F;
            --google-color: #4285F4;
            --important-color: #E07A5F; 
            --star-inactive: #ccc;
            --star-active: #E07A5F;
            --card-bg: #FFFFFF;
            --danger-color: #D32F2F;
            --search-highlight: #FFEB3B;
            --search-marker: #FF4081;
            
            --tag-oneoff: #89C9B8;
            --tag-daily: #F2A0A1;
            --tag-weekly: #F6D365;
            --tag-monthly: #A0C1B8;
            --tag-google: #AECBFA;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .app-container {
            width: 95%; max-width: 1000px; height: 90vh;
            background-color: var(--card-bg); border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: flex;
            overflow: hidden; position: relative; 
        }

        .sidebar {
            width: 35%; background-color: #F8F4E6; padding: 30px;
            border-right: 1px solid var(--accent-color); display: flex; flex-direction: column;
            overflow-y: auto; touch-action: pan-y; overflow-x: hidden;
        }

        /* --- æ¤œç´¢ã‚¨ãƒªã‚¢ --- */
        .search-box { margin-bottom: 10px; position: relative; }
        .search-input {
            width: 100%; padding: 10px 35px 10px 15px; border: 2px solid var(--accent-color);
            border-radius: 20px; font-family: inherit; outline: none; transition: 0.3s;
        }
        .search-input:focus { border-color: var(--text-color); background-color: #fff; }
        .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #aaa; pointer-events: none; }
        .search-result-msg { font-size: 0.75em; color: var(--search-marker); text-align: center; margin-bottom: 5px; min-height: 1.2em; font-weight: bold; }

        /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        .calendar-header {
            font-size: 1.1em; font-weight: bold; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.6); padding: 8px 12px; border-radius: 15px; user-select: none;
        }
        .nav-btn {
            background: none; border: none; cursor: pointer; font-size: 1.2em;
            color: var(--text-color); width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .nav-btn:hover { background-color: var(--accent-color); color: white; }
        
        /* â˜… å¹´æœˆè¡¨ç¤ºéƒ¨åˆ†ã‚’ãƒœã‚¿ãƒ³åŒ– */
        #monthDisplay {
            cursor: pointer; padding: 5px 10px; border-radius: 10px; transition: 0.2s;
        }
        #monthDisplay:hover { background-color: rgba(255,255,255,0.8); color: var(--accent-color); }

        .today-btn {
            font-size: 0.7em; background-color: var(--text-color); color: white; border: none;
            padding: 4px 10px; border-radius: 12px; cursor: pointer; transition: 0.2s; margin-left: 5px;
        }
        .today-btn:hover { opacity: 0.8; }

        /* --- ã‚°ãƒªãƒƒãƒ‰ã‚·ã‚¹ãƒ†ãƒ  (æœˆãƒ»å¹´å…±é€š) --- */
        .calendar-grid {
            display: grid; gap: 4px; text-align: center; min-height: 250px;
            user-select: none; width: 100%; transition: opacity 0.2s;
        }

        /* æœˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®ã‚°ãƒªãƒƒãƒ‰ (7åˆ—) */
        .grid-month-view { grid-template-columns: repeat(7, 1fr); }
        
        /* å¹´è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®ã‚°ãƒªãƒƒãƒ‰ (3åˆ—) */
        .grid-year-view { 
            grid-template-columns: repeat(3, 1fr); 
            align-content: start; 
            gap: 10px; 
            padding-top: 20px;
        }

        .weekday { font-size: 0.8em; color: #888; padding-bottom: 5px; font-weight: bold; }

        /* --- æ—¥ä»˜ã‚»ãƒ« (æœˆè¡¨ç¤ºç”¨) --- */
        .day {
            aspect-ratio: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; border-radius: 50%;
            cursor: pointer; font-size: 0.9em; position: relative; border: 2px solid transparent;
            touch-action: manipulation;
        }
        .day:hover { background-color: rgba(212, 196, 181, 0.3); }
        .day.active { border-color: var(--text-color); font-weight: bold; background-color: rgba(93, 85, 80, 0.1); }
        .day.empty { cursor: default; pointer-events: none; }
        .day.has-pending::after { content: ''; width: 5px; height: 5px; background-color: var(--pending-dot); border-radius: 50%; position: absolute; bottom: 3px; }
        .day.has-important::before { content: 'â˜…'; position: absolute; top: -3px; right: -3px; font-size: 0.8em; color: var(--important-color); line-height: 1; }
        .day.perfect { background-color: var(--highlight) !important; color: white; }
        .day.perfect.search-hit { background-color: var(--search-marker) !important; color: white !important; border: 2px solid white !important; }
        .day.search-hit { border: 2px solid var(--search-marker) !important; color: var(--search-marker); font-weight: bold; background-color: #FFF0F5; }

        /* --- æœˆã‚»ãƒ« (å¹´è¡¨ç¤ºç”¨) --- */
        .month-cell {
            aspect-ratio: 1.5; /* æ¨ªé•· */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 10px; cursor: pointer; border: 1px solid var(--accent-color);
            background-color: #fff; transition: 0.2s; font-weight: bold; color: var(--text-color);
            position: relative;
        }
        .month-cell:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .month-cell.current-month { background-color: var(--text-color); color: white; border-color: var(--text-color); }
        
        /* å¹´è¡¨ç¤ºã§ã®æ¤œç´¢ãƒ’ãƒƒãƒˆ */
        .month-cell.has-search-hit {
            border: 2px solid var(--search-marker);
            background-color: #FFF0F5;
            color: var(--search-marker);
        }
        .month-cell.has-search-hit::after {
            content: attr(data-hit-count); /* ä»¶æ•°ã‚’è¡¨ç¤º */
            position: absolute; bottom: 5px; right: 8px;
            font-size: 0.7em; background: var(--search-marker); color: white;
            padding: 2px 6px; border-radius: 10px;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeInZoom { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .anim-fade { animation: fadeInZoom 0.3s ease-out; }
        mark { background-color: var(--search-highlight); color: inherit; padding: 0 2px; border-radius: 2px; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (å¤‰æ›´ãªã—) */
        .main-content { width: 65%; padding: 40px 50px; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .date-header { font-size: 2em; font-weight: bold; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .progress-display { font-size: 0.5em; background-color: #F0EBE0; padding: 5px 15px; border-radius: 20px; color: var(--text-color); font-weight: normal; white-space: nowrap; }
        .divider { border-bottom: 2px dashed var(--accent-color); margin-bottom: 20px; }
        .section-title { color: #8C8480; margin-bottom: 10px; font-weight: bold; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .todo-input { flex-grow: 1; padding: 12px; border: 1px solid var(--accent-color); border-radius: 10px; font-family: inherit; outline: none; background-color: #FAFAFA; min-width: 200px; font-size: 16px; }
        .type-select { padding: 10px; border: 1px solid var(--accent-color); border-radius: 10px; font-family: inherit; background-color: #fff; color: var(--text-color); cursor: pointer; font-size: 14px; }
        .important-label { display: flex; align-items: center; gap: 5px; color: var(--important-color); font-weight: bold; cursor: pointer; font-size: 0.9em; background: #fff; padding: 8px 12px; border-radius: 10px; border: 1px solid #FFE4E4; }
        .important-label input { transform: scale(1.3); accent-color: var(--important-color); margin: 0; }
        .add-btn { background:var(--accent-color); color:#fff; border:none; border-radius:10px; padding:12px 25px; cursor:pointer; font-weight:bold; }
        .todo-list { list-style: none; padding: 0; margin-bottom: 30px; }
        .todo-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; animation: fadeIn 0.3s ease; padding-left: 5px; min-height: 40px; }
        .todo-item.is-important { background-color: #FFF5F5; border-left: 4px solid var(--important-color); border-radius: 0 5px 5px 0; }
        .todo-item input[type="checkbox"] { margin-right: 15px; transform: scale(1.3); accent-color: var(--highlight); cursor: pointer; flex-shrink: 0; width: 20px; height: 20px; }
        .todo-content { flex-grow: 1; display: flex; align-items: center; justify-content: space-between; }
        .todo-item.is-important .todo-content span { font-weight: bold; color: #C06050; }
        .action-buttons { display: flex; align-items: center; gap: 10px; }
        .delete-btn, .star-btn { background: none; border: none; cursor: pointer; font-size: 1.3em; padding: 5px 10px; transition: 0.2s; line-height: 1; }
        .delete-btn:hover { color: var(--delete-btn); }
        .star-btn.active { color: var(--star-active); }
        .star-btn.inactive { color: var(--star-inactive); }
        .badge { font-size: 0.75em; padding: 4px 10px; border-radius: 12px; color: white; margin-left: 5px; font-weight: bold; white-space: nowrap; }
        .badge-oneoff { background-color: var(--tag-oneoff); }
        .badge-daily  { background-color: var(--tag-daily); }
        .badge-weekly { background-color: var(--tag-weekly); }
        .badge-monthly{ background-color: var(--tag-monthly); }
        .badge-google { background-color: var(--tag-google); color: #333; }
        .journal-section { margin-top: auto; }
        .journal-title { color: #8C8480; font-weight: bold; margin-bottom: 10px; }
        .journal-area { width: 100%; height: 120px; padding: 15px; border: 1px solid var(--accent-color); background-color: #FDFBF7; border-radius: 10px; resize: none; font-family: inherit; line-height: 1.6; box-sizing: border-box; outline: none; font-size: 16px; }
        .data-controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--accent-color); display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .btn-control { font-size: 0.85em; padding: 10px 15px; background-color: #fff; border: 1px solid var(--accent-color); border-radius: 20px; cursor: pointer; color: var(--text-color); transition: 0.2s; flex-grow: 1; text-align: center; min-width: 80px; }
        .btn-control:hover { background-color: var(--accent-color); color: white; }
        .btn-google { border-color: var(--google-color); color: var(--google-color); font-weight: bold; }
        .btn-google:hover { background-color: var(--google-color); color: white; }
        .btn-danger { border-color: var(--danger-color); color: var(--danger-color); font-weight: bold; }
        .btn-danger:hover { background-color: var(--danger-color); color: white; }

        @media (max-width: 768px) {
            body { height: auto; min-height: 100vh; display: block; background-color: var(--card-bg); padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }
            .app-container { width: 100%; max-width: none; height: auto; min-height: 100vh; flex-direction: column; border-radius: 0; box-shadow: none; overflow: visible; }
            .sidebar { width: 100%; border-right: none; border-bottom: 2px solid var(--accent-color); padding: 15px; box-sizing: border-box; height: auto; overflow: visible; background-color: #F8F4E6; z-index: 2; }
            .day { font-size: 1em; aspect-ratio: 1; }
            .calendar-grid { gap: 4px; }
            .main-content { width: 100%; padding: 20px; box-sizing: border-box; height: auto; overflow: visible; background-color: #FFFFFF; z-index: 1; display: flex; flex-direction: column; }
            .date-header { order: 1; font-size: 1.5em; margin-top: 10px; }
            .divider { order: 2; }
            .section-title { order: 3; }
            .todo-list { order: 4; margin-bottom: 20px; }
            .input-group { order: 5; margin-bottom: 30px; border-top: 1px dashed #eee; padding-top: 20px; flex-direction: column; align-items: stretch;}
            .journal-section { order: 6; }
            .todo-input { width: 100%; margin-bottom: 10px; }
            .add-btn { width: 100%; margin-top: 10px; }
            .type-select, .important-label { width: 100%; box-sizing: border-box; justify-content: center; margin-bottom: 10px;}
            .data-controls { padding-bottom: 40px; }
        }
    </style>
</head>
<body>
    <script> window.onerror = function(message) { console.error(message); }; </script>

    <div class="app-container">
        <aside class="sidebar" id="swipeArea">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="Search..." oninput="handleSearch()">
                <span class="search-icon">ğŸ”</span>
            </div>
            <div class="search-result-msg" id="searchResultMsg"></div>

            <div class="calendar-header">
                <button class="nav-btn" onclick="navigateCalendar(-1)">&#10094;</button>
                <div style="display:flex; align-items:center;">
                    <span id="monthDisplay" onclick="toggleViewMode()">Loading...</span>
                    <button class="today-btn" onclick="resetToToday()">Today</button>
                </div>
                <button class="nav-btn" onclick="navigateCalendar(1)">&#10095;</button>
            </div>
            
            <div class="calendar-grid" id="calendarGrid"></div>
            
            <div style="margin-top:20px; font-size:0.8rem; color:#888; text-align:center; line-height: 1.6;">
                <span style="color:var(--highlight)">â—</span> Perfect! <br>
                <span style="color:var(--pending-dot)">â—</span> Todoã‚ã‚Š / <span style="color:var(--important-color)">â˜…</span> é‡è¦
            </div>
            
            <div class="data-controls">
                <button class="btn-control btn-google" onclick="document.getElementById('icalInput').click()">ğŸ“… Googleèª­è¾¼</button>
                <input type="file" id="icalInput" style="display:none" onchange="importIcal(this)" accept=".ics">
                <button class="btn-control" onclick="exportData()">ğŸ“¤ ä¿å­˜</button>
                <button class="btn-control" onclick="document.getElementById('fileInput').click()">ğŸ“¥ èª­è¾¼</button>
                <input type="file" id="fileInput" style="display:none" onchange="importData(this)" accept=".json">
                <button class="btn-control btn-danger" onclick="resetApp()">âš ï¸ å…¨å‰Šé™¤</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="date-header">
                <span id="headerDateDisplay">Select a Date</span>
                <span class="progress-display" id="progressDisplay">0%</span>
            </div>
            <div class="divider"></div>

            <div class="section-title">ğŸŒ¿ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</div>
            
            <div class="input-group">
                <input type="text" class="todo-input" id="taskInput" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯...">
                <div style="display:flex; gap:10px; width:100%;">
                    <select id="taskType" class="type-select" style="flex:1">
                        <option value="oneoff">ğŸ“… å˜ç™º</option>
                        <option value="daily">ğŸ” æ¯æ—¥</option>
                        <option value="weekly">ğŸ“… æ¯é€±</option>
                        <option value="monthly">ğŸŒ™ æ¯æœˆ</option>
                    </select>
                    <label class="important-label" style="flex:1">
                        <input type="checkbox" id="importantCheck"> â˜… é‡è¦
                    </label>
                </div>
                <button class="add-btn" onclick="handleAddTask()">è¿½åŠ </button>
            </div>

            <ul class="todo-list" id="todoList"></ul>

            <div class="journal-section">
                <div class="journal-title">ğŸ“ ä»Šæ—¥ã®ã²ã¨ã“ã¨æ—¥è¨˜</div>
                <textarea class="journal-area" id="journalInput" placeholder="ä»Šæ—¥ã¯ã©ã‚“ãª1æ—¥ã ã£ãŸï¼Ÿ" oninput="handleDiaryInput()"></textarea>
            </div>
        </main>
    </div>

    <script>
        let taskDefinitions = []; let completionLog = []; let diaryEntries = {}; 
        const today = new Date();
        let viewYear = today.getFullYear(); let viewMonth = today.getMonth() + 1; 
        let selectedDateObj = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        let currentSearchQuery = "";
        // â˜… è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ç®¡ç†ç”¨ãƒ•ãƒ©ã‚° (false:æœˆè¡¨ç¤º, true:å¹´è¡¨ç¤º)
        let isYearView = false;

        function loadData() {
            try {
                const savedDefs = localStorage.getItem('gemTask_definitions');
                const savedLogs = localStorage.getItem('gemTask_logs');
                const savedDiary = localStorage.getItem('gemTask_diary');
                if (savedDefs) taskDefinitions = JSON.parse(savedDefs);
                if (savedLogs) completionLog = JSON.parse(savedLogs);
                if (savedDiary) diaryEntries = JSON.parse(savedDiary);
                if (!savedDefs && !savedLogs && !savedDiary) initDefaultData();
            } catch (e) { initDefaultData(); }
        }
        function initDefaultData() {
            taskDefinitions = []; completionLog = []; diaryEntries = {};
            taskDefinitions.push({ id: 1, text: "GemTaskã¸ã‚ˆã†ã“ã", type: "oneoff", targetDate: today.getDate(), targetYear: today.getFullYear(), targetMonth: today.getMonth()+1, isImportant: true });
            saveData();
        }
        function saveData() {
            try {
                localStorage.setItem('gemTask_definitions', JSON.stringify(taskDefinitions));
                localStorage.setItem('gemTask_logs', JSON.stringify(completionLog));
                localStorage.setItem('gemTask_diary', JSON.stringify(diaryEntries));
            } catch (e) {}
        }

        /* --- View Control Logic --- */
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function toggleViewMode() {
            isYearView = !isYearView;
            updateUI('anim-fade');
        }

        // æœˆã‚’é¸æŠã—ã¦æœˆè¡¨ç¤ºã¸é·ç§»
        function selectMonth(m) {
            viewMonth = m;
            isYearView = false;
            // ãã®æœˆã®1æ—¥ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            selectedDateObj = new Date(viewYear, viewMonth - 1, 1);
            updateUI('anim-fade');
        }

        // å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
        function navigateCalendar(offset) {
            if (isYearView) {
                // å¹´è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€Œå¹´ã€ã‚’ç§»å‹•
                viewYear += offset;
            } else {
                // æœˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€Œæœˆã€ã‚’ç§»å‹•
                viewMonth += offset;
                if (viewMonth > 12) { viewMonth = 1; viewYear++; } 
                else if (viewMonth < 1) { viewMonth = 12; viewYear--; }
                selectedDateObj = new Date(viewYear, viewMonth - 1, 1);
            }
            
            const anim = offset > 0 ? 'anim-next' : 'anim-prev';
            updateUI(anim);
        }

        // ä»Šæ—¥ã¸æˆ»ã‚‹
        function resetToToday() { 
            viewYear = today.getFullYear(); viewMonth = today.getMonth() + 1; 
            selectedDateObj = new Date(today.getFullYear(), today.getMonth(), today.getDate()); 
            isYearView = false; // æœˆè¡¨ç¤ºã«æˆ»ã™
            updateUI('anim-fade');
        }

        /* --- UI Update Master --- */
        // ç”»é¢æç”»ã®å¸ä»¤å¡”
        function updateUI(animationClass = '') {
            renderCalendarHeader();
            
            if (isYearView) {
                renderYearGrid(animationClass);
                // å¹´è¡¨ç¤ºä¸­ã¯å³å´ã®ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆãªã©ã¯ç©ºã«ã™ã‚‹ã‹ã€ä½•ã‚‚ã—ãªã„ï¼ˆä»Šå›ã¯ãã®ã¾ã¾æ®‹ã™ãŒæ“ä½œå¯¾è±¡å¤–ï¼‰
            } else {
                renderMonthGrid(animationClass);
                renderTasks();
                // æ—¥è¨˜ã‚¨ãƒªã‚¢æ›´æ–°
                const dateStr = getDateString(selectedDateObj);
                document.getElementById('journalInput').value = diaryEntries[dateStr] || "";
            }
            
            updateSearchCount();
        }

        function renderCalendarHeader() {
            const display = document.getElementById('monthDisplay');
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            if (isYearView) {
                display.textContent = `${viewYear}`; // å¹´ã ã‘è¡¨ç¤º
            } else {
                display.textContent = `${monthNames[viewMonth - 1]} ${viewYear}`; // æœˆ+å¹´
            }
            
            // å³å´ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚‚æ›´æ–°
            const dateStr = getDateString(selectedDateObj);
            const dayOfWeekStr = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][selectedDateObj.getDay()];
            document.getElementById('headerDateDisplay').textContent = `${viewMonth}/${selectedDateObj.getDate()} ${dayOfWeekStr}`;
        }

        /* --- Render Grids --- */
        // â˜… æœˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®æç”» (æ—§ renderCalendar)
        function renderMonthGrid(animationClass) {
            const grid = document.getElementById('calendarGrid');
            grid.className = 'calendar-grid grid-month-view'; // ã‚¯ãƒ©ã‚¹åˆ‡ã‚Šæ›¿ãˆ
            void grid.offsetWidth; if(animationClass) grid.classList.add(animationClass);
            grid.innerHTML = "";

            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            weekdays.forEach(day => { const el = document.createElement('div'); el.className = 'weekday'; el.textContent = day; grid.appendChild(el); });

            const firstDay = new Date(viewYear, viewMonth - 1, 1).getDay(); 
            const daysInMonth = new Date(viewYear, viewMonth, 0).getDate();

            for (let i = 0; i < firstDay; i++) { const el = document.createElement('div'); el.className = 'day empty'; grid.appendChild(el); }
            for (let i = 1; i <= daysInMonth; i++) {
                const el = document.createElement('div'); el.className = 'day'; el.textContent = i;
                
                // ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
                const tasks = getTasksForDate(i, viewMonth, viewYear); // å¼•æ•°è¿½åŠ 
                if (tasks.length > 0) {
                    const dateStr = `${viewYear}-${viewMonth}-${i}`;
                    const completedCount = tasks.filter(t => completionLog.some(log => log.taskId === t.id && log.dateStr === dateStr)).length;
                    if (completedCount === tasks.length) el.classList.add('perfect'); else el.classList.add('has-pending');
                    if (tasks.some(t => t.isImportant)) el.classList.add('has-important');
                }
                
                // æ¤œç´¢ãƒ’ãƒƒãƒˆ
                if(checkSearchHit(i, viewMonth, viewYear)) el.classList.add('search-hit');

                if(!isYearView && i === selectedDateObj.getDate() && viewMonth === (selectedDateObj.getMonth() + 1) && viewYear === selectedDateObj.getFullYear()) el.classList.add('active');
                
                el.onclick = () => { selectedDateObj = new Date(viewYear, viewMonth - 1, i); updateUI(); };
                grid.appendChild(el);
            }
        }

        // â˜… å¹´è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®æç”» (æ–°è¦ä½œæˆ)
        function renderYearGrid(animationClass) {
            const grid = document.getElementById('calendarGrid');
            grid.className = 'calendar-grid grid-year-view'; // ã‚¯ãƒ©ã‚¹åˆ‡ã‚Šæ›¿ãˆ
            void grid.offsetWidth; if(animationClass) grid.classList.add(animationClass);
            grid.innerHTML = "";

            const monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

            for (let m = 1; m <= 12; m++) {
                const el = document.createElement('div');
                el.className = 'month-cell';
                el.textContent = monthNamesShort[m-1];
                
                // ä»Šè¡¨ç¤ºã—ã¦ã„ãŸæœˆãªã‚‰å¼·èª¿
                if(m === viewMonth) el.classList.add('current-month');

                // â˜… æ¤œç´¢ãƒ’ãƒƒãƒˆãƒã‚§ãƒƒã‚¯ (å¹´è¡¨ç¤ºç”¨)
                if (currentSearchQuery) {
                    // ãã®æœˆã«ãƒ’ãƒƒãƒˆã™ã‚‹ã‚‚ã®ãŒã„ãã¤ã‚ã‚‹ã‹è¨ˆç®—
                    let hitCount = 0;
                    const daysInM = new Date(viewYear, m, 0).getDate();
                    for(let d=1; d<=daysInM; d++) {
                        if(checkSearchHit(d, m, viewYear)) hitCount++;
                    }
                    if (hitCount > 0) {
                        el.classList.add('has-search-hit');
                        el.setAttribute('data-hit-count', hitCount); // ä»¶æ•°ã‚’CSSã§è¡¨ç¤º
                    }
                }

                el.onclick = () => selectMonth(m);
                grid.appendChild(el);
            }
        }

        /* --- Search Logic Update --- */
        function handleSearch() {
            const input = document.getElementById('searchInput');
            currentSearchQuery = input.value.trim().toLowerCase();
            updateUI(); // å…¨ä½“æ›´æ–°
        }

        function updateSearchCount() {
            const msg = document.getElementById('searchResultMsg');
            if (!currentSearchQuery) { msg.textContent = ""; return; }
            
            // å¹´è¡¨ç¤ºãªã‚‰ã€Œä»Šå¹´ã®ãƒ’ãƒƒãƒˆæ•°ã€ã€æœˆè¡¨ç¤ºãªã‚‰ã€Œä»Šæœˆã®ãƒ’ãƒƒãƒˆæ•°ã€
            let totalHits = 0;
            if (isYearView) {
                // å…¨æœˆã®åˆè¨ˆ
                for(let m=1; m<=12; m++) {
                    const daysInM = new Date(viewYear, m, 0).getDate();
                    for(let d=1; d<=daysInM; d++) { if(checkSearchHit(d, m, viewYear)) totalHits++; }
                }
                msg.textContent = `${totalHits} matches in ${viewYear}`;
            } else {
                const daysInM = new Date(viewYear, viewMonth, 0).getDate();
                for(let d=1; d<=daysInM; d++) { if(checkSearchHit(d, viewMonth, viewYear)) totalHits++; }
                msg.textContent = `${totalHits} matches in this month`;
            }
        }

        // å¼•æ•°ã‚’æ‹¡å¼µã—ã¦æ±ç”¨åŒ–
        function checkSearchHit(day, month, year) {
            if (!currentSearchQuery) return false;
            const query = currentSearchQuery;
            
            const tasks = getTasksForDate(day, month, year);
            const taskHit = tasks.some(t => t.text.toLowerCase().includes(query));
            
            const dateStr = `${year}-${month}-${day}`;
            const journalText = diaryEntries[dateStr] || "";
            const journalHit = journalText.toLowerCase().includes(query);
            
            return taskHit || journalHit;
        }

        /* --- Helper Logic --- */
        // å¼•æ•°ã§å¹´æœˆã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£
        function getTasksForDate(day, month, year) {
            const targetDateObj = new Date(year, month - 1, day); 
            const weekday = targetDateObj.getDay();
            return taskDefinitions.filter(task => {
                if (task.type === 'daily') return true;
                if (task.type === 'weekly') return task.targetWeekday === weekday;
                if (task.type === 'monthly') return task.targetDayOfMonth === day;
                if (task.type === 'google' || task.type === 'oneoff') { 
                    const tYear = task.targetYear || viewYear; 
                    const tMonth = task.targetMonth || viewMonth; 
                    return task.targetDate === day && tYear === year && tMonth === month; 
                }
                return false;
            });
        }

        function highlightText(text) {
            if (!currentSearchQuery) return text;
            const regex = new RegExp(`(${escapeRegExp(currentSearchQuery)})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }
        function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
        function getDateString(dateObj) { const y = dateObj.getFullYear(); const m = dateObj.getMonth() + 1; const d = dateObj.getDate(); return `${y}-${m}-${d}`; }

        /* --- Swipe Logic --- */
        const swipeArea = document.getElementById('swipeArea');
        let touchStartX = 0; let touchEndX = 0;
        swipeArea.addEventListener('touchstart', function(e) { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
        swipeArea.addEventListener('touchend', function(e) { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, {passive: true});
        function handleSwipe() { if (Math.abs(touchStartX - touchEndX) > 50) { if (touchStartX - touchEndX > 0) navigateCalendar(1); else navigateCalendar(-1); } }

        /* --- Reset & Import/Export (Same as before) --- */
        function resetApp() { if(confirm("ã€è­¦å‘Šã€‘ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('gemTask_definitions'); localStorage.removeItem('gemTask_logs'); localStorage.removeItem('gemTask_diary'); initDefaultData(); resetToToday(); alert("åˆæœŸåŒ–ã—ã¾ã—ãŸğŸŒ±"); } }
        function importIcal(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result; const events = parseIcal(content);
                    if (events.length > 0) {
                        let count = 0;
                        events.forEach(ev => {
                            const exists = taskDefinitions.some(t => t.text === ev.title && t.targetDate === ev.day && t.type === 'google' && t.targetYear === ev.year && t.targetMonth === ev.month);
                            if (!exists) { taskDefinitions.push({ id: Date.now() + Math.random(), text: ev.title, type: "google", targetDate: ev.day, targetYear: ev.year, targetMonth: ev.month, targetWeekday: null, targetDayOfMonth: null, isImportant: false }); count++; }
                        });
                        saveData(); updateUI('anim-fade'); alert(`${count}ä»¶èª­ã¿è¾¼ã¿ã¾ã—ãŸğŸ“…`);
                    } else { alert("äºˆå®šãªã—ğŸ’¦"); }
                } catch(e) { alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼"); }
            };
            reader.readAsText(file); input.value = '';
        }
        function parseIcal(icalData) {
            const events = []; const lines = icalData.split(/\r\n|\n|\r/); let inEvent = false; let currentEvent = {};
            lines.forEach(line => {
                if (line.startsWith('BEGIN:VEVENT')) { inEvent = true; currentEvent = {}; }
                else if (line.startsWith('END:VEVENT')) { inEvent = false; if (currentEvent.summary && currentEvent.dtstart) { const dateStr = currentEvent.dtstart; if (dateStr.length >= 8) { events.push({ title: currentEvent.summary, year: parseInt(dateStr.substring(0, 4)), month: parseInt(dateStr.substring(4, 6)), day: parseInt(dateStr.substring(6, 8)) }); } } }
                else if (inEvent) { if (line.startsWith('SUMMARY:')) currentEvent.summary = line.substring(8); else if (line.startsWith('DTSTART')) { const parts = line.split(':'); if (parts.length > 1) currentEvent.dtstart = parts[1]; } }
            });
            return events;
        }
        function exportData() {
            const data = { definitions: taskDefinitions, logs: completionLog, diary: diaryEntries };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `gemtask_backup_${getDateString(selectedDateObj)}.json`; a.click(); URL.revokeObjectURL(url);
        }
        function importData(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.definitions) taskDefinitions = data.definitions;
                    if(data.logs) completionLog = data.logs;
                    if(data.diary) diaryEntries = data.diary;
                    saveData(); resetToToday(); alert("å¾©å…ƒã—ã¾ã—ãŸâœ¨");
                } catch (err) { alert("èª­è¾¼ã‚¨ãƒ©ãƒ¼"); }
            };
            reader.readAsText(file); input.value = '';
        }
        
        // --- Task Handling ---
        function renderTasks() {
            const list = document.getElementById('todoList'); const progressDisplay = document.getElementById('progressDisplay'); list.innerHTML = "";
            const day = selectedDateObj.getDate(); const dateStr = getDateString(selectedDateObj); const tasks = getTasksForDate(day, viewMonth, viewYear);
            let completedCount = 0;
            if (tasks.length === 0) { progressDisplay.textContent = "No Tasks"; progressDisplay.style.backgroundColor = "#F0EBE0"; progressDisplay.style.color = "#aaa"; }
            else {
                completedCount = tasks.filter(t => completionLog.some(log => log.taskId === t.id && log.dateStr === dateStr)).length;
                const percentage = Math.round((completedCount / tasks.length) * 100);
                if (percentage === 100) { progressDisplay.textContent = `100% Perfect! ğŸ‰`; progressDisplay.style.backgroundColor = "var(--highlight)"; progressDisplay.style.color = "white"; }
                else { progressDisplay.textContent = `é”æˆç‡: ${percentage}% (${completedCount}/${tasks.length})`; progressDisplay.style.backgroundColor = "#F0EBE0"; progressDisplay.style.color = "var(--text-color)"; }
            }
            tasks.forEach(task => {
                const li = document.createElement('li'); li.className = `todo-item ${task.isImportant ? 'is-important' : ''}`;
                const isCompleted = completionLog.some(log => log.taskId === task.id && log.dateStr === dateStr);
                let badgeHtml = "", badgeText = "";
                if (task.type === 'daily') { badgeHtml = "badge-daily"; badgeText = "æ¯æ—¥"; } else if (task.type === 'weekly') { badgeHtml = "badge-weekly"; badgeText = "æ¯é€±"; } else if (task.type === 'monthly') { badgeHtml = "badge-monthly"; badgeText = "æ¯æœˆ"; } else if (task.type === 'google') { badgeHtml = "badge-google"; badgeText = "Google"; } else { badgeHtml = "badge-oneoff"; badgeText = "å˜ç™º"; }
                const starClass = task.isImportant ? 'active' : 'inactive'; const starIcon = task.isImportant ? 'â˜…' : 'â˜†';
                const displayText = highlightText(task.text);
                li.innerHTML = `
                    <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="toggleTask(${task.id})">
                    <div class="todo-content">
                        <span>${displayText}</span>
                        <div class="action-buttons"><span class="badge ${badgeHtml}">${badgeText}</span><button class="star-btn ${starClass}" onclick="toggleImportance(${task.id})">${starIcon}</button><button class="delete-btn" onclick="deleteTask(${task.id})">ğŸ—‘ï¸</button></div>
                    </div>`;
                list.appendChild(li);
            });
        }
        function handleAddTask() {
            const input = document.getElementById('taskInput'); const typeSelect = document.getElementById('taskType'); const importantCheck = document.getElementById('importantCheck');
            const text = input.value.trim(); if (!text) return;
            const newTask = { id: Date.now(), text: text, type: typeSelect.value, targetDate: typeSelect.value === 'oneoff' ? selectedDateObj.getDate() : null, targetYear: typeSelect.value === 'oneoff' ? viewYear : null, targetMonth: typeSelect.value === 'oneoff' ? viewMonth : null, targetWeekday: typeSelect.value === 'weekly' ? selectedDateObj.getDay() : null, targetDayOfMonth: typeSelect.value === 'monthly' ? selectedDateObj.getDate() : null, isImportant: importantCheck.checked };
            taskDefinitions.push(newTask); saveData(); input.value = ""; importantCheck.checked = false; updateUI();
        }
        function toggleTask(id) {
            const dateStr = getDateString(selectedDateObj); const existingIndex = completionLog.findIndex(log => log.taskId === id && log.dateStr === dateStr);
            if (existingIndex !== -1) completionLog.splice(existingIndex, 1); else completionLog.push({ taskId: id, dateStr: dateStr });
            saveData(); updateUI();
        }
        function toggleImportance(id) { const task = taskDefinitions.find(t => t.id === id); if (task) { task.isImportant = !task.isImportant; saveData(); updateUI(); } }
        function deleteTask(id) { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { taskDefinitions = taskDefinitions.filter(t => t.id !== id); completionLog = completionLog.filter(log => log.taskId !== id); saveData(); updateUI(); } }
        function handleDiaryInput() { const text = document.getElementById('journalInput').value; const dateStr = getDateString(selectedDateObj); diaryEntries[dateStr] = text; saveData(); updateSearchCount(); }

        window.onload = () => { loadData(); updateUI('anim-fade'); };
    </script>
</body>
</html>